<!-- id: struct.packages -->
<!-- status: decided -->
<!-- summary: Semver with maximal version selection, lock files, registry, local cache -->
<!-- depends: structure/build.md -->

# Package Versioning and Dependencies

Semantic versioning with maximal version selection, `build.rk` package block for dependencies, generated lock file for reproducibility.

## Versioning

| Rule | Description |
|------|-------------|
| **VR1: Semver** | `MAJOR.MINOR.PATCH` — breaking.features.fixes |
| **VR2: Pre-release** | `MAJOR.MINOR.PATCH-LABEL.N` (e.g., `1.0.0-beta.3`) — not stable, exact match only |
| **VR3: 0.x unstable** | MINOR bump in `0.x` may be breaking — treated conservatively |

## Version Constraints

| Constraint | Meaning |
|------------|---------|
| `"1.2.3"` or `"^1.2.3"` | Compatible: `>=1.2.3, <2.0.0` |
| `"~1.2.3"` | Tilde: `>=1.2.3, <1.3.0` (patch only) |
| `"=1.2.3"` | Exact version |
| `"1.2"` | Compatible: `>=1.2.0, <2.0.0` |

Default: bare version → `^` (compatible). For `0.x`: bare → `~` (patch only, since MINOR may break).

## Dependency Resolution

| Rule | Description |
|------|-------------|
| **MV1: Maximum compatible** | Select the newest version satisfying all constraints |
| **MV2: Deterministic** | Same inputs + same registry state → same outputs |
| **MV3: Upgrade-stable** | Adding a dependency cannot downgrade existing deps |
| **MV4: Conflict error** | Incompatible constraints produce a clear error |
| **MV5: Lock pins** | `rask.lock` records exact resolved versions — builds are reproducible regardless of new registry publishes |

Algorithm: build transitive dependency graph → collect all version constraints per package → select newest satisfying version → verify → generate lock file.

## Lock File

| Rule | Description |
|------|-------------|
| **LK1: Reproducibility** | `rask.lock` records exact versions of all transitive dependencies |
| **LK2: Auto-generated** | Generated by `rask build` or `rask fetch` — don't hand-edit |
| **LK3: Checksum** | SHA-256 hash per package for integrity verification |
| **LK4: Sync required** | Out-of-date lock file errors with "run `rask update`" |

| Command | Effect |
|---------|--------|
| `rask build` | Use lock file if exists, generate if missing |
| `rask fetch` | Download dependencies, update lock file |
| `rask update` | Resolve latest compatible versions, update lock |
| `rask update <pkg>` | Update specific package |

## Package Registry

| Rule | Description |
|------|-------------|
| **RG1: Default** | `https://packages.rk-lang.org` is the official registry |
| **RG2: Immutable** | Once published, versions can't be changed or deleted |
| **RG3: No path deps** | Packages with path dependencies can't be published |
| **RG4: Alternative registries** | Per-package or per-project registry override |

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/pkg/<name>` | GET | Package metadata (all versions) |
| `/pkg/<name>/<version>` | GET | Download specific version (tarball) |
| `/publish` | POST | Publish new version |

## Dependency Cache

| Rule | Description |
|------|-------------|
| **CA1: Location** | `~/.rk/cache/deps/` (Linux/macOS), `%USERPROFILE%\.rk\cache\deps\` (Windows), `RASK_CACHE` override |
| **CA2: Checksum verified** | Verified on every read; corrupted entries re-downloaded |
| **CA3: Concurrent-safe** | Cache is read-only after population |

## Workspaces

| Rule | Description |
|------|-------------|
| **WS1: Members** | `members: ["app", "lib1", "lib2"]` in workspace root `build.rk` |
| **WS2: Shared lock** | Single `rask.lock` at workspace root |
| **WS3: Path deps** | Members reference each other via path dependencies |

## Error Messages

```
ERROR [struct.packages/MV4]: dependency conflict
  Cannot resolve: X requires foo ^1.0, Y requires foo ^2.0

FIX: Check if X or Y has a newer version compatible with the other.
```

```
ERROR [struct.packages/LK4]: lock file out of sync
  rask.lock doesn't match build.rk dependencies

FIX: rask update
```

## Edge Cases

| Case | Rule | Handling |
|------|------|----------|
| Missing `build.rk` | — | No external deps, version 0.0.0 |
| Lock file out of date | LK4 | Error: run `rask update` |
| Network unavailable | CA1 | Error: check network or cache |
| Checksum mismatch | CA2 | Error: possible tampering |
| Circular dependency | MV1 | Error with cycle path shown |
| 0.x MINOR bump | VR3 | Treated as breaking |
| Pre-release in constraint | VR2 | Must use exact: `=1.0.0-beta.1` |
| Path dep in publish | RG3 | Error |
| Dev-dependency conflict | MV1 | Dev-deps don't affect transitive resolution |

---

## Appendix (non-normative)

### Rationale

**MV1 (maximal compatible):** Select the newest compatible version. Developers expect the latest bug fixes when they write `dep "http" "^2.0"`. The lock file provides reproducibility — once resolved, versions don't change until `rask update`.

**LK1 (lock files):** Applications should commit `rask.lock` for reproducibility. Libraries may omit it (consumers resolve their own versions).

### Dependency Sources

<!-- test: skip -->
```rask
dep "http" "^2.1"                        // Registry (default)
dep "parser" { git: "https://github.com/author/parser.git", branch: "main" }
dep "mylib" { path: "../mylib" }         // Local
dep "mylib" "^1.0" { path: "../mylib" }  // Path for dev, version for publishing
```

### Best Practices

**Library authors:**
- Start at `0.1.0`, bump to `1.0.0` when stable
- MAJOR for breaking, MINOR for features, PATCH for fixes

**Application authors:**
- Commit `rask.lock`
- Use `^` constraints (allow compatible updates)
- Pin critical deps with `=` for security-critical libs

### Deprecation

```rask
@deprecated(since = "2.1.0", note = "Use new_function instead")
public func old_function() { ... }
```

### Remaining Issues

**Medium priority:**
1. Private registry authentication
2. Vendoring mechanism for offline builds
3. Yanking (hide versions from new resolution)

**Low priority:**
4. Mirror registries
5. Patch dependency overrides

### See Also

- `struct.build` — package block, build scripts
- `struct.modules` — import resolution, package organization
