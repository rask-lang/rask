// Test channels for cross-thread communication

@entry
func main() {
    // Create a buffered channel
    const ch = Channel.buffered(10)
    const tx = ch.sender
    const rx = ch.receiver

    // Send from a thread, receive in main
    const handle = spawn_raw {
        try tx.send(42)
        try tx.send(100)
    }

    const v1 = try rx.recv()
    const v2 = try rx.recv()
    try handle.join()

    println(v1)   // 42
    println(v2)   // 100

    // Producer-consumer pattern
    const ch2 = Channel.buffered(5)
    const tx2 = ch2.sender
    const rx2 = ch2.receiver

    const producer = spawn_raw {
        let i = 0
        loop {
            if i >= 5 {
                break
            }
            try tx2.send(i * 10)
            i = i + 1
        }
    }

    try producer.join()

    // Consume all messages
    let sum = 0
    let j = 0
    loop {
        if j >= 5 {
            break
        }
        const val = try rx2.recv()
        sum = sum + val
        j = j + 1
    }
    println(sum)  // 0 + 10 + 20 + 30 + 40 = 100

    println("channels: all tests passed")
}
